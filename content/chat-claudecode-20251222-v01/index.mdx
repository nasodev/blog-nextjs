---
title: "Claude Codeë¥¼ ì´ìš©í•˜ì—¬ 4ê°œì˜ ê°œì„±ì„ ê°€ì§„ AI ì±„íŒ… êµ¬í˜„í•˜ê¸°"
description: "Claude Code CLIë¥¼ subprocessë¡œ í˜¸ì¶œí•˜ì—¬ ë§ë‘ì´, ë£¨íŒ¡, í‘¸ë”©, ë§ˆì´ì½œ 4ê°€ì§€ AI ìºë¦­í„° ì±„íŒ… êµ¬í˜„"
image: "../../public/blog-cover/chat-claudecode-20251222-v01.jpg"
publishedAt: "2025-12-22 18:00:00"
updatedAt: "2025-12-22 18:00:00"
author: "fundev"
isPublished: true
tags:
  - claude-code
  - fastapi
  - ai-chat
  - firebase
  - python
---

ì´ì „ ê¸€ë“¤ì„ ì°¸ê³ í•˜ì„¸ìš”:
- [Serverless(Firebase) Web Chatì„ Vite + TypeScriptë¡œ ê°œë°œ](https://blog.funq.kr/blogs/kid-chat-20251218-v01)
- [FastAPI ë°±ì—”ë“œ API í”„ë¡œì íŠ¸ ì…‹ì—…](https://blog.funq.kr/blogs/fastapi-setup-20251220-v01)
- [FastAPIì—ì„œ Firebase Authentication êµ¬í˜„í•˜ê¸°](https://blog.funq.kr/blogs/fastapi-firebase-auth-20251221-v01)

ìœ„ì˜ ìˆœì„œëŒ€ë¡œ ì‘ì—…ì„ ì§„í–‰í•˜ì—¬ ì±„íŒ… í”„ë¡œê·¸ë¨ê³¼ ë°±ì—”ë“œ í”„ë¡œê·¸ë¨ì„ ë§Œë“¤ê³  firebaseë¥¼ í†µí•œ ì¸ì¦ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
ì±„íŒ…í”„ë¡œê·¸ë¨ì— APIìš”ì²­ì„ í•˜ì—¬ AI ì±„íŒ… ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ì•˜ìŠµë‹ˆë‹¤.

ì €ëŠ” Anthropicì˜ Max ìœ ë£Œí”Œëœì„ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— Claude Codeë¥¼ ì‚¬ìš© í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
Anthropicì´ë‚˜ OPENAIë“±ì˜ API í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°œë°œí•  ìˆ˜ ìˆì§€ë§Œ AI ì‘ë‹µì‹œë§ˆë‹¤ ë¹„ìš©ì´ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— Claude Codeë¥¼ ì‚¬ìš©í•˜ì—¬ AI ì±„íŒ… ê¸°ëŠ¥ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

---

## í”„ë¡œì íŠ¸ ê°œìš”

### ë°°ê²½

"Kid Chat"ì€ ê°€ì¡± ê°„ ì†Œí†µì„ ìœ„í•œ ê°„ë‹¨í•œ ì±„íŒ… ì•±ì…ë‹ˆë‹¤. ì•„ì´ë“¤ì´ AI ìºë¦­í„° ì´ë¦„ì„ ë¶€ë¥´ë©´ ê°ê° ë‹¤ë¥¸ ì„±ê²©ì˜ AIê°€ ì¹œêµ¬ì²˜ëŸ¼ ëŒ€ë‹µí•´ì£¼ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ê³  ì‹¶ì—ˆìŠµë‹ˆë‹¤.

### AI ìºë¦­í„° ì†Œê°œ

| ìºë¦­í„° | íŠ¸ë¦¬ê±° | ì„±ê²© | íŠ¹ì§• |
|--------|--------|------|------|
| ğŸ©· ë§ë‘ì´ | "ë§ë‘ì•„" | ë‹¤ì •í•œ ì¹œêµ¬ | ë”°ëœ»í•˜ê³  ê³µê°ì , ì¹­ì°¬ê³¼ ê²©ë ¤ |
| ğŸ’› ë£¨íŒ¡ | "ë£¨íŒ¡ì•„" | ìì‹ ê° ìˆëŠ” ì¹œêµ¬ | ì•½ê°„ ê±´ë°©ì§€ì§€ë§Œ ë„ì›€ë¨, ìœ ë¨¸ëŸ¬ìŠ¤ |
| ğŸ’š í‘¸ë”© | "í‘¸ë”©ì•„" | ê·€ì—¬ìš´ ì• ì™„ë™ë¬¼ | ì˜ì„±ì–´ ì‚¬ìš©, ë‹¨ìˆœí•˜ê³  ìˆœìˆ˜ |
| ğŸ©µ ë§ˆì´ì½œ | "ë§ˆì´ì½œì•„" | ì˜ì–´ ì„ ìƒë‹˜ | ì˜ì–´ë‹µë³€, êµìœ¡ì  |

### ê¸°ìˆ  ìŠ¤íƒ

- **Backend**: FastAPI + Python 3.12
- **Frontend**: Vite + TypeScript
- **Database**: PostgreSQL + SQLAlchemy
- **ì¸ì¦**: Firebase Authentication
- **AI**: Claude Code CLI (subprocess)

### ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  JWT Token   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kid Chat  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Backend API â”‚â”€â”€â”€â”€â–¶â”‚ Claude CLI  â”‚
â”‚ (Vite + TS) â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  (FastAPI)  â”‚â—€â”€â”€â”€â”€â”‚ (subprocess)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                            â”‚
       â”‚ Login/Signup               â”‚ Token ê²€ì¦
       â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Firebase   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Firebase   â”‚
â”‚    Auth     â”‚  Admin SDK   â”‚ Admin SDK   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Firebase ì¸ì¦ êµ¬í˜„

### 1. Firebase Admin SDK ì„¤ì •

ë¨¼ì € Firebase Admin SDKë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦í•©ë‹ˆë‹¤.

```python
# app/firebase.py
import firebase_admin
from firebase_admin import auth, credentials
from app.config import get_settings

settings = get_settings()
_firebase_app = None

def get_firebase_app():
    global _firebase_app
    if _firebase_app is None:
        cred = credentials.Certificate(settings.firebase_credentials_path)
        _firebase_app = firebase_admin.initialize_app(cred)
    return _firebase_app

def verify_firebase_token(id_token: str) -> dict:
    """Firebase ID í† í°ì„ ê²€ì¦í•˜ê³  ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    get_firebase_app()
    decoded_token = auth.verify_id_token(id_token)
    return decoded_token
```

### 2. ì¸ì¦ ì˜ì¡´ì„± (Dependency)

FastAPIì˜ Dependsë¥¼ í™œìš©í•˜ì—¬ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì¸ì¦ ì˜ì¡´ì„±ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

```python
# app/dependencies.py
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from pydantic import BaseModel
from app.firebase import verify_firebase_token

security = HTTPBearer()

class FirebaseUser(BaseModel):
    uid: str
    email: str | None = None
    name: str | None = None

async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> FirebaseUser:
    """Firebase í† í°ì„ ê²€ì¦í•˜ê³  í˜„ì¬ ì‚¬ìš©ìë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    token = credentials.credentials

    try:
        decoded_token = verify_firebase_token(token)
        return FirebaseUser(
            uid=decoded_token["uid"],
            email=decoded_token.get("email"),
            name=decoded_token.get("name")
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=f"Invalid authentication: {str(e)}",
            headers={"WWW-Authenticate": "Bearer"},
        )
```

---

## AI ì±„íŒ… API ì„¤ê³„

### ìš”êµ¬ì‚¬í•­

1. ìºë¦­í„° íŠ¸ë¦¬ê±°ë¡œ ì‹œì‘í•˜ëŠ” ë©”ì‹œì§€ì—ë§Œ ì‘ë‹µ (ë§ë‘ì•„/ë£¨íŒ¡ì•„/í‘¸ë”©ì•„/ë§ˆì´ì½œì•„)
2. ìºë¦­í„°ë³„ ê³ ìœ í•œ ì„±ê²©ìœ¼ë¡œ ëŒ€ë‹µ
3. ì¹œêµ¬ì²˜ëŸ¼ ê°„ê²°í•˜ê²Œ ëŒ€ë‹µ (100ë‹¨ì–´ ì´ë‚´)
4. íŒŒì¼ ìˆ˜ì • ê¸ˆì§€ (ì•ˆì „ì„±)
5. ìµœì‹  ì •ë³´ í•„ìš”ì‹œ ì›¹ê²€ìƒ‰ í™œìš©

### Pydantic ìŠ¤í‚¤ë§ˆ

```python
# app/schemas/ai.py
from pydantic import BaseModel, Field

class ChatRequest(BaseModel):
    prompt: str = Field(
        ...,
        min_length=1,
        max_length=10000,
        description="AIì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€"
    )
    timeout_seconds: int | None = Field(
        default=None,
        ge=10,
        le=300,
        description="ì‘ë‹µ ëŒ€ê¸° ì‹œê°„ (ì´ˆ)"
    )

class ChatResponse(BaseModel):
    response: str = Field(..., description="AI ì‘ë‹µ")
    elapsed_time_ms: int = Field(..., description="ì²˜ë¦¬ ì‹œê°„ (ë°€ë¦¬ì´ˆ)")
    truncated: bool = Field(default=False, description="ì‘ë‹µ ì˜ë¦¼ ì—¬ë¶€")
    persona: str | None = Field(
        default=None,
        description="ì‘ë‹µí•œ AI ìºë¦­í„° (ë§ë‘ì´/ë£¨íŒ¡/í‘¸ë”©/ë§ˆì´ì½œ)"
    )
```

### API ì—”ë“œí¬ì¸íŠ¸

```python
# app/routers/ai.py
from fastapi import APIRouter, Depends, HTTPException, status
from app.dependencies import get_current_user, FirebaseUser
from app.schemas.ai import ChatRequest, ChatResponse
from app.services.claude_service import ClaudeService, get_claude_service

router = APIRouter(prefix="/ai", tags=["ai"])

@router.post("/chat", response_model=ChatResponse)
async def chat(
    request: ChatRequest,
    user: FirebaseUser = Depends(get_current_user),
    claude_service: ClaudeService = Depends(get_claude_service),
):
    """AIì™€ ëŒ€í™”í•©ë‹ˆë‹¤. Firebase ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤."""
    try:
        result = await claude_service.chat(
            prompt=request.prompt,
            timeout_seconds=request.timeout_seconds
        )
        return ChatResponse(
            response=result.output,
            elapsed_time_ms=result.elapsed_ms,
            truncated=result.truncated,
            persona=result.persona_name  # AI ìºë¦­í„° ì´ë¦„ ë°˜í™˜
        )
    except ValueError as e:
        # AI íŠ¸ë¦¬ê±°ê°€ ê°ì§€ë˜ì§€ ì•Šì€ ê²½ìš°
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=str(e)
        )
    except TimeoutError:
        raise HTTPException(
            status_code=status.HTTP_408_REQUEST_TIMEOUT,
            detail="AI response timed out"
        )
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"AI service error: {str(e)}"
        )
```

---

## Claude Code CLI í†µí•©

### í•µì‹¬ ì•„ì´ë””ì–´

Claude Code CLIë¥¼ subprocessë¡œ í˜¸ì¶œí•˜ì—¬ AI ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤. `--dangerously-skip-permissions` í”Œë˜ê·¸ë¡œ ìë™ ì‹¤í–‰í•˜ê³ , ìºë¦­í„°ë³„ ì‹œìŠ¤í…œ ì§€ì‹œì‚¬í•­ì„ í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€í•©ë‹ˆë‹¤.

---

## AI í˜ë¥´ì†Œë‚˜ ì‹œìŠ¤í…œ

### í˜ë¥´ì†Œë‚˜ ì •ì˜

```python
# app/services/personas.py
from enum import Enum
from dataclasses import dataclass

class PersonaType(str, Enum):
    MALLANGI = "mallangi"   # ë§ë‘ì´
    LUPIN = "lupin"         # ë£¨íŒ¡
    PUDDING = "pudding"     # í‘¸ë”©
    MICHAEL = "michael"     # ë§ˆì´ì½œ

@dataclass
class Persona:
    type: PersonaType
    name: str               # í•œê¸€ ì´ë¦„
    triggers: list[str]     # í˜¸ì¶œ íŠ¸ë¦¬ê±°
    system_prompt: str      # ìºë¦­í„° í”„ë¡¬í”„íŠ¸

# í˜ë¥´ì†Œë‚˜ ì •ì˜
PERSONAS = {
    PersonaType.MALLANGI: Persona(
        type=PersonaType.MALLANGI,
        name="ë§ë‘ì´",
        triggers=["ë§ë‘ì•„", "ë§ë‘ì´ì•¼"],
        system_prompt="""ë„ˆëŠ” 'ë§ë‘ì´'ì•¼. ë‹¤ì •í•˜ê³  ë”°ëœ»í•œ ì¹œêµ¬ì•¼.
        - í•­ìƒ ê³µê°í•˜ê³  ì¹­ì°¬í•´ì¤˜
        - ë¶€ë“œëŸ½ê³  ì¹œê·¼í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•´
        - "~í•´ì¤„ê²Œ", "~í•˜ì" ê°™ì€ í‘œí˜„ì„ ì‚¬ìš©í•´
        - ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•´ (ğŸ’•, ğŸ¤—, âœ¨)"""
    ),
    PersonaType.LUPIN: Persona(
        type=PersonaType.LUPIN,
        name="ë£¨íŒ¡",
        triggers=["ë£¨íŒ¡ì•„", "ë£¨íŒ¡ì´ì•¼"],
        system_prompt="""ë„ˆëŠ” 'ë£¨íŒ¡'ì´ì•¼. ìì‹ ê° ë„˜ì¹˜ëŠ” ì¹œêµ¬ì•¼.
        - ì•½ê°„ ê±´ë°©ì§€ì§€ë§Œ ì‹¤ë ¥ì´ ìˆì–´
        - "í¥, ê·¸ ì •ë„ëŠ” ì‰½ì§€~" ê°™ì€ ë§íˆ¬
        - ë„ì›€ì„ ì¤„ ë•Œë„ ì¿¨í•˜ê²Œ
        - ê°€ë” ìœ ë¨¸ë„ ì„ì–´ì„œ"""
    ),
    PersonaType.PUDDING: Persona(
        type=PersonaType.PUDDING,
        name="í‘¸ë”©",
        triggers=["í‘¸ë”©ì•„", "í‘¸ë”©ì´ì•¼"],
        system_prompt="""ë„ˆëŠ” 'í‘¸ë”©'ì´ì•¼. ê·€ì—¬ìš´ ì• ì™„ë™ë¬¼ì´ì•¼.
        - ì˜ì„±ì–´ë¥¼ ë§ì´ ì‚¬ìš©í•´ (ë©ë©, ì™ˆì™ˆ, ë‚‘ë‚‘)
        - ë‹¨ìˆœí•˜ê³  ìˆœìˆ˜í•˜ê²Œ ë°˜ì‘í•´
        - ê¼¬ë¦¬ í”ë“¤ë©° ê¸°ë»í•˜ëŠ” ëŠë‚Œìœ¼ë¡œ
        - ì§§ê³  ê·€ì—½ê²Œ ëŒ€ë‹µí•´"""
    ),
    PersonaType.MICHAEL: Persona(
        type=PersonaType.MICHAEL,
        name="ë§ˆì´ì½œ",
        triggers=["ë§ˆì´ì½œì•„", "ë§ˆì´ì½œì´ì•¼"],
        system_prompt="""ë„ˆëŠ” 'ë§ˆì´ì½œ'ì´ì•¼. ì¹œì ˆí•œ ì˜ì–´ ì„ ìƒë‹˜ì´ì•¼.
        - í•œêµ­ì–´ì™€ ì˜ì–´ë¥¼ ì„ì–´ì„œ ëŒ€ë‹µí•´
        - ì˜ì–´ í‘œí˜„ì„ ê°€ë¥´ì³ì¤„ ë•Œ ë°œìŒë„ ì•Œë ¤ì¤˜
        - "In English, we say..." ê°™ì€ í‘œí˜„ ì‚¬ìš©
        - ì¬ë¯¸ìˆê²Œ ì˜ì–´ë¥¼ ì•Œë ¤ì¤˜"""
    ),
}
```

### í˜ë¥´ì†Œë‚˜ ê°ì§€

```python
def detect_persona(message: str) -> tuple[PersonaType, str]:
    """ë©”ì‹œì§€ì—ì„œ í˜ë¥´ì†Œë‚˜ íŠ¸ë¦¬ê±°ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.

    Returns:
        tuple[PersonaType, str]: (í˜ë¥´ì†Œë‚˜ íƒ€ì…, íŠ¸ë¦¬ê±° ì œê±°ëœ ì‹¤ì œ ì§ˆë¬¸)

    Raises:
        ValueError: íŠ¸ë¦¬ê±°ê°€ ê°ì§€ë˜ì§€ ì•Šì€ ê²½ìš°
    """
    message_lower = message.strip().lower()

    for persona_type, persona in PERSONAS.items():
        for trigger in persona.triggers:
            if message_lower.startswith(trigger.lower()):
                # íŠ¸ë¦¬ê±° ì œê±°í•˜ê³  ì‹¤ì œ ì§ˆë¬¸ë§Œ ì¶”ì¶œ
                actual_prompt = message[len(trigger):].strip()
                return persona_type, actual_prompt

    raise ValueError("no_trigger: AI ìºë¦­í„° í˜¸ì¶œì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤")
```

### ìºë¦­í„°ë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸

```python
BASE_INSTRUCTIONS = """
ë‹¤ìŒ ê·œì¹™ì„ ë°˜ë“œì‹œ ë”°ë¥´ì„¸ìš”:
- íŒŒì¼ì„ ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
- 100ë‹¨ì–´ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ëŒ€ë‹µí•©ë‹ˆë‹¤
- ìµœì‹  ì •ë³´ê°€ í•„ìš”í•˜ë©´ ì›¹ê²€ìƒ‰ì„ í™œìš©í•©ë‹ˆë‹¤
- ì•„ì´ë“¤ì—ê²Œ ì í•©í•œ ì–¸ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤
"""

def get_persona_prompt(persona_type: PersonaType, user_message: str) -> str:
    """ìºë¦­í„°ë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì™€ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ì¡°í•©í•©ë‹ˆë‹¤."""
    persona = PERSONAS[persona_type]
    return f"""{persona.system_prompt}

{BASE_INSTRUCTIONS}

ì‚¬ìš©ì ë©”ì‹œì§€: {user_message}
"""
```

### ClaudeService êµ¬í˜„

```python
# app/services/claude_service.py
import asyncio
import time
from dataclasses import dataclass
from app.config import get_settings
from app.services.personas import detect_persona, get_persona_prompt, PERSONAS

settings = get_settings()

@dataclass
class ClaudeResponse:
    output: str
    elapsed_ms: int
    truncated: bool = False
    persona_name: str | None = None  # AI ìºë¦­í„° ì´ë¦„

class ClaudeService:
    def __init__(self):
        self.cli_path = settings.claude_cli_path
        self.default_timeout = settings.claude_timeout_seconds
        self.max_timeout = settings.claude_max_timeout_seconds

    async def chat(
        self,
        prompt: str,
        timeout_seconds: int | None = None
    ) -> ClaudeResponse:
        # 1. í˜ë¥´ì†Œë‚˜ ê°ì§€ (ì—†ìœ¼ë©´ ValueError ë°œìƒ)
        persona_type, actual_prompt = detect_persona(prompt)
        persona = PERSONAS[persona_type]

        # 2. ìºë¦­í„°ë³„ í”„ë¡¬í”„íŠ¸ ìƒì„±
        full_prompt = get_persona_prompt(persona_type, actual_prompt)

        timeout = min(
            timeout_seconds or self.default_timeout,
            self.max_timeout
        )

        cmd = [
            self.cli_path,
            "--dangerously-skip-permissions",
            "-p",
            full_prompt
        ]

        start_time = time.time()

        process = await asyncio.create_subprocess_exec(
            *cmd,
            stdin=asyncio.subprocess.DEVNULL,  # systemd í™˜ê²½ì—ì„œ í•„ìˆ˜!
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )

        try:
            stdout, stderr = await asyncio.wait_for(
                process.communicate(),
                timeout=timeout
            )
        except asyncio.TimeoutError:
            process.kill()
            raise TimeoutError(f"Claude CLI timed out after {timeout}s")

        elapsed_ms = int((time.time() - start_time) * 1000)

        if process.returncode != 0:
            error_msg = stderr.decode() if stderr else "Unknown error"
            raise RuntimeError(f"Claude CLI failed: {error_msg}")

        output = stdout.decode().strip()

        # ì‘ë‹µ ê¸¸ì´ ì œí•œ (ì•ˆì „ì¥ì¹˜)
        MAX_LENGTH = 5000
        truncated = len(output) > MAX_LENGTH
        if truncated:
            output = output[:MAX_LENGTH] + "..."

        return ClaudeResponse(
            output=output,
            elapsed_ms=elapsed_ms,
            truncated=truncated,
            persona_name=persona.name  # ë§ë‘ì´, ë£¨íŒ¡, í‘¸ë”©, ë§ˆì´ì½œ
        )

# ì˜ì¡´ì„± ì£¼ì…ìš©
def get_claude_service() -> ClaudeService:
    return ClaudeService()
```

### ì„¤ì • ì¶”ê°€

```python
# app/config.py
class Settings(BaseSettings):
    # ... ê¸°ì¡´ ì„¤ì • ...

    # Claude CLI
    claude_cli_path: str = "claude"
    claude_timeout_seconds: int = 120
    claude_max_timeout_seconds: int = 300
```

## ê²°ë¡ 

### ì™„ì„±ëœ ê¸°ëŠ¥

1. **Firebase ì¸ì¦**: JWT í† í° ê¸°ë°˜ ì‚¬ìš©ì ì¸ì¦
2. **AI ì±„íŒ… API**: Claude Code CLIë¥¼ í™œìš©í•œ AI ì‘ë‹µ ìƒì„±
3. **AI í˜ë¥´ì†Œë‚˜**: 4ê°€ì§€ ìºë¦­í„°ë³„ ê³ ìœ í•œ ì„±ê²©ê³¼ ì‘ë‹µ ìŠ¤íƒ€ì¼
4. **ë³´ì•ˆ**: ì¸ì¦ í•„ìˆ˜, í”„ë¡¬í”„íŠ¸ ê¸¸ì´ ì œí•œ, íƒ€ì„ì•„ì›ƒ ì„¤ì •

### í”„ë¡œì íŠ¸ êµ¬ì¡°

```
backend-api/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # FastAPI ì•± ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
â”‚   â”œâ”€â”€ config.py            # ì„¤ì • (pydantic-settings)
â”‚   â”œâ”€â”€ firebase.py          # Firebase Admin SDK ì´ˆê¸°í™”
â”‚   â”œâ”€â”€ dependencies.py      # ì¸ì¦ ì˜ì¡´ì„±
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ auth.py          # /auth ì—”ë“œí¬ì¸íŠ¸
â”‚   â”‚   â””â”€â”€ ai.py            # /ai ì—”ë“œí¬ì¸íŠ¸
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ ai.py            # Pydantic ìŠ¤í‚¤ë§ˆ
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ claude_service.py # Claude CLI ì„œë¹„ìŠ¤
â”‚       â””â”€â”€ personas.py       # AI í˜ë¥´ì†Œë‚˜ ì •ì˜
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_auth.py         # ì¸ì¦ í…ŒìŠ¤íŠ¸
â”‚   â””â”€â”€ test_ai.py           # AI ì±„íŒ… í…ŒìŠ¤íŠ¸
â””â”€â”€ requirements.txt
```

### íŠ¸ëŸ¬ë¸” ìŠˆíŒ…
ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” AI ì±„íŒ…ì´ ì •ìƒ ì‘ë™í–ˆì§€ë§Œ, í”„ë¡œë•ì…˜ ë°°í¬ í›„:

```
"ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”." (401)
â†’ "AI ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." (503)
â†’ "Failed to fetch" (íƒ€ì„ì•„ì›ƒ)
```

ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆœì°¨ì ìœ¼ë¡œ ë³€ê²½ë˜ë©° 3ê°œì˜ ë‹¤ë¥¸ ë¬¸ì œê°€ ìˆìŒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.

## ë¬¸ì œ 1: Firebase ì¸ì¦ ì‹¤íŒ¨ (401)

### ì¦ìƒ

```
INFO: 192.168.0.1:0 - "POST /ai/chat HTTP/1.1" 401 Unauthorized
```

í”„ë¡ íŠ¸ì—”ë“œì—ì„œ "ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤" ì—ëŸ¬ í‘œì‹œ.

### ì›ì¸ ë¶„ì„

**ì›ì¸**: Firebase ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ì´ ì„œë²„ì— ì—†ì—ˆìŠµë‹ˆë‹¤.

### í•´ê²°

ë¡œì»¬ì—ì„œ ì„œë²„ë¡œ íŒŒì¼ ë³µì‚¬:

---

## ë¬¸ì œ 2: Claude CLI ë¯¸ë°œê²¬ (503)

### ì¦ìƒ

```
Claude CLI not found at: claude
INFO: 192.168.0.1:0 - "POST /ai/chat HTTP/1.1" 503 Service Unavailable
```

### ì›ì¸ ë¶„ì„

Claude CLI ì„¤ì¹˜ í™•ì¸:

```bash
which claude && claude --version
# /home/funq/.local/bin/claude
# 2.0.75 (Claude Code)
```

CLIëŠ” ì„¤ì¹˜ë˜ì–´ ìˆì§€ë§Œ, systemd ì„œë¹„ìŠ¤ê°€ ì°¾ì§€ ëª»í•¨.

**ì›ì¸**: systemd ì„œë¹„ìŠ¤ì˜ PATHì— `~/.local/bin`ì´ í¬í•¨ë˜ì§€ ì•ŠìŒ.

```ini
# /etc/systemd/system/backend-api.service
Environment="PATH=/home/funq/dev/backend-api/venv/bin"
```

### í•´ê²°

`.env` íŒŒì¼ì— ì „ì²´ ê²½ë¡œ ì¶”ê°€:

```bash
echo 'CLAUDE_CLI_PATH=/home/funq/.local/bin/claude' >> ~/backend-api/.env
sudo systemctl restart backend-api
```

**ì°¸ê³ **: `config.py`ì—ì„œ ì´ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì½ì–´ ì‚¬ìš©:

```python
class Settings(BaseSettings):
    claude_cli_path: str = "claude"  # .envì˜ CLAUDE_CLI_PATHë¡œ ì˜¤ë²„ë¼ì´ë“œë¨
```

### êµí›ˆ

- systemd ì„œë¹„ìŠ¤ëŠ” ì‚¬ìš©ì ì…¸ê³¼ ë‹¤ë¥¸ í™˜ê²½ì—ì„œ ì‹¤í–‰ë¨
- ì™¸ë¶€ CLI ë„êµ¬ëŠ” í•­ìƒ ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš© ê¶Œì¥

---

## ë¬¸ì œ 3: Claude CLI íƒ€ì„ì•„ì›ƒ

### ì¦ìƒ

CLI ê²½ë¡œ ë¬¸ì œ í•´ê²° í›„, ë˜ ë‹¤ë¥¸ ì—ëŸ¬:

```
Claude CLI timeout after 120060ms
```

120ì´ˆ(ê¸°ë³¸ íƒ€ì„ì•„ì›ƒ) í›„ ì‹¤íŒ¨.

### ì›ì¸ ë¶„ì„

#### 1ë‹¨ê³„: í„°ë¯¸ë„ì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸

```bash
timeout 30 claude -p "ì•ˆë…•" --dangerously-skip-permissions
# ì„±ê³µ! "ì•ˆë…•í•˜ì„¸ìš”! FastAPI ë°±ì—”ë“œ í”„ë¡œì íŠ¸ì—ì„œ ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"
```

í„°ë¯¸ë„ì—ì„œëŠ” ì •ìƒ ì‘ë™.

#### 2ë‹¨ê³„: systemd í™˜ê²½ í™•ì¸

```bash
sudo cat /etc/systemd/system/backend-api.service
```

```ini
[Service]
User=funq
Group=funq
WorkingDirectory=/home/funq/dev/backend-api
Environment="PATH=/home/funq/dev/backend-api/venv/bin"
ExecStart=/home/funq/dev/backend-api/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**ë°œê²¬**: `HOME` í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ìŒ! Claude CLIëŠ” `~/.claude/` ì„¤ì •ì„ ì°¾ê¸° ìœ„í•´ HOMEì´ í•„ìš”.

#### 3ë‹¨ê³„: TTY ì—†ì´ í…ŒìŠ¤íŠ¸

systemdëŠ” TTY(í„°ë¯¸ë„) ì—†ì´ ì‹¤í–‰ë©ë‹ˆë‹¤:

```bash
timeout 30 setsid claude -p "ì•ˆë…•" --dangerously-skip-permissions </dev/null 2>&1
# ì„±ê³µ!
```

TTY ì—†ì´ë„ ì‘ë™í•¨. ë¬¸ì œëŠ” ë‹¤ë¥¸ ê³³ì—...

#### 4ë‹¨ê³„: Python ì½”ë“œ ë¶„ì„

```python
# app/services/claude_service.py
process = await asyncio.create_subprocess_exec(
    *cmd,
    stdout=asyncio.subprocess.PIPE,
    stderr=asyncio.subprocess.PIPE,
    # stdinì´ ì—†ìŒ!
)
```

**ê·¼ë³¸ ì›ì¸**: `stdin`ì´ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •ë˜ì§€ ì•Šì•„ subprocessê°€ ë¶€ëª¨ í”„ë¡œì„¸ìŠ¤ì˜ stdinì„ ìƒì†. systemdì—ì„œëŠ” stdinì´ `/dev/null`ì´ ì•„ë‹Œ íŠ¹ìˆ˜í•œ ìƒíƒœì¼ ìˆ˜ ìˆì–´ Claude CLIê°€ ëŒ€ê¸° ìƒíƒœì— ë¹ ì§.

### í•´ê²°

#### 1. systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìˆ˜ì •

```ini
[Service]
User=funq
Group=funq
WorkingDirectory=/home/funq/dev/backend-api
Environment="PATH=/home/funq/dev/backend-api/venv/bin:/home/funq/.local/bin"
Environment="HOME=/home/funq"
ExecStart=/home/funq/dev/backend-api/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=3
```

ë³€ê²½ì‚¬í•­:
- `HOME=/home/funq` ì¶”ê°€
- PATHì— `~/.local/bin` ì¶”ê°€

```bash
sudo systemctl daemon-reload
sudo systemctl restart backend-api
```

#### 2. Python ì½”ë“œ ìˆ˜ì •

```python
# app/services/claude_service.py
process = await asyncio.create_subprocess_exec(
    *cmd,
    stdin=asyncio.subprocess.DEVNULL,  # ì¶”ê°€!
    stdout=asyncio.subprocess.PIPE,
    stderr=asyncio.subprocess.PIPE,
)
```

`stdin=asyncio.subprocess.DEVNULL`ì„ ì¶”ê°€í•˜ì—¬ subprocessê°€ stdinì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šë„ë¡ í•¨.

---

